<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#3A2E28">
<title>Studio Flow ‚Äì Agendamento</title>
<script src="https://sdk.mercadopago.com/js/v2"></script>
<style>
  :root {
    --cream:#F7F3EE;--beige:#EDE5D8;--sand:#D9CCBA;--taupe:#B8A898;
    --brown:#7A6455;--dark:#3A2E28;--gold:#C9A84C;--gold-light:#E8D49A;
    --white:#FDFAF7;--error:#C0392B;--success:#5A8A6A;
    --font-d:'Cormorant Garamond',serif;--font-b:'Jost',sans-serif;
  }
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body{font-family:var(--font-b);background:var(--cream);color:var(--dark);min-height:100vh;overflow-x:hidden}
  .screen{display:none;min-height:100vh;flex-direction:column;animation:fadeIn .35s ease}
  .screen.active{display:flex}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  #s-home{background:var(--dark);align-items:center;justify-content:center;text-align:center;position:relative;overflow:hidden}
  #s-home::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 50% 30%,#5a3e2e55 0%,transparent 70%),radial-gradient(ellipse at 80% 80%,#c9a84c22 0%,transparent 60%)}
  .h-logo{font-family:var(--font-d);font-size:3.8rem;font-weight:300;color:var(--white);letter-spacing:.12em;line-height:1;margin-bottom:6px;position:relative}
  .h-tag{font-size:.7rem;letter-spacing:.35em;color:var(--gold-light);text-transform:uppercase;margin-bottom:56px;position:relative}
  .h-div{width:40px;height:1px;background:var(--gold);margin:0 auto 56px;position:relative}
  .h-btns{display:flex;flex-direction:column;align-items:center;position:relative;width:100%;padding:0 32px}
  .h-bottom{position:absolute;bottom:32px;font-size:.65rem;color:#ffffff33;letter-spacing:.15em}
  .btn-p{display:inline-block;background:var(--gold);color:var(--dark);font-family:var(--font-b);font-size:.75rem;font-weight:600;letter-spacing:.22em;text-transform:uppercase;padding:16px 40px;border:none;cursor:pointer;transition:all .25s;width:100%;max-width:280px}
  .btn-p:hover{background:var(--gold-light);transform:translateY(-1px)}
  .btn-s{display:inline-block;background:transparent;color:var(--taupe);font-family:var(--font-b);font-size:.7rem;font-weight:400;letter-spacing:.2em;text-transform:uppercase;padding:14px 32px;border:1px solid #ffffff22;cursor:pointer;transition:all .25s;width:100%;max-width:280px;margin-top:12px}
  .btn-s:hover{border-color:var(--taupe);color:var(--white)}
  .ph{background:var(--dark);padding:18px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
  .ph-logo{font-family:var(--font-d);font-size:1.5rem;font-weight:300;color:var(--white);letter-spacing:.08em}
  .ph-sub{font-size:.58rem;font-weight:500;letter-spacing:.28em;color:var(--gold);text-transform:uppercase}
  .btn-back{background:none;border:none;color:var(--taupe);cursor:pointer;font-size:1.4rem;padding:4px;transition:color .2s}
  .btn-back:hover{color:var(--white)}
  .pb{flex:1;padding:26px 24px 48px;overflow-y:auto}
  .steps{display:flex;align-items:center;justify-content:center;margin-bottom:28px}
  .step{display:flex;flex-direction:column;align-items:center;gap:4px}
  .sn{width:28px;height:28px;border-radius:50%;border:1.5px solid var(--sand);background:var(--white);font-size:.7rem;font-weight:600;color:var(--taupe);display:flex;align-items:center;justify-content:center;transition:all .3s}
  .step.active .sn{border-color:var(--gold);background:var(--gold);color:var(--dark)}
  .step.done .sn{border-color:var(--success);background:var(--success);color:white}
  .sl{font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;color:var(--taupe)}
  .step.active .sl{color:var(--dark)}
  .sline{width:28px;height:1px;background:var(--sand);margin:0 4px 12px}
  .t1{font-family:var(--font-d);font-size:1.9rem;font-weight:300;color:var(--dark);margin-bottom:4px;line-height:1.1}
  .t2{font-size:.7rem;color:var(--taupe);letter-spacing:.15em;text-transform:uppercase;margin-bottom:24px}
  .fg{margin-bottom:18px}
  .fl{display:block;font-size:.63rem;font-weight:600;letter-spacing:.22em;text-transform:uppercase;color:var(--brown);margin-bottom:7px}
  .fi{width:100%;background:var(--white);border:1px solid var(--sand);padding:13px 15px;font-family:var(--font-b);font-size:.9rem;color:var(--dark);outline:none;transition:border-color .2s;appearance:none;border-radius:0}
  .fi:focus{border-color:var(--gold)}
  .fi::placeholder{color:var(--taupe);font-size:.83rem}
  textarea.fi{resize:vertical;min-height:80px}
  .pcards{display:flex;flex-direction:column;gap:11px;margin-bottom:20px}
  .pcard{background:var(--white);border:1.5px solid var(--sand);padding:15px;cursor:pointer;transition:all .2s;position:relative}
  .pcard.sel{border-color:var(--gold);background:#fdf8f0}
  .pn{font-family:var(--font-d);font-size:1.1rem;font-weight:500;color:var(--dark);margin-bottom:3px}
  .ps{font-size:.68rem;color:var(--taupe)}
  .pck{position:absolute;right:13px;top:50%;transform:translateY(-50%);width:22px;height:22px;border-radius:50%;border:1.5px solid var(--sand);display:flex;align-items:center;justify-content:center;transition:all .2s;font-size:.73rem;color:transparent}
  .pcard.sel .pck{background:var(--gold);border-color:var(--gold);color:white}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px}
  .chip{padding:8px 15px;border:1.5px solid var(--sand);background:var(--white);font-size:.73rem;font-weight:500;color:var(--brown);cursor:pointer;transition:all .2s}
  .chip.sel{border-color:var(--gold);background:var(--gold);color:var(--dark);font-weight:600}
  .tgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:20px}
  .ts{padding:12px 4px;border:1.5px solid var(--sand);background:var(--white);font-size:.8rem;font-weight:500;color:var(--brown);text-align:center;cursor:pointer;transition:all .2s}
  .ts.sel{border-color:var(--gold);background:var(--gold);color:var(--dark)}
  .ts.busy{opacity:.3;pointer-events:none;text-decoration:line-through}
  .scard{background:var(--white);border:1px solid var(--sand);padding:20px;margin-bottom:22px}
  .srow{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--beige);font-size:.83rem}
  .srow:last-child{border-bottom:none}
  .sk{color:var(--taupe);font-size:.7rem;letter-spacing:.1em;text-transform:uppercase}
  .sv{color:var(--dark);font-weight:500}
  .stotal{font-family:var(--font-d);font-size:1.3rem;font-weight:500}
  .ptabs{display:flex;margin-bottom:22px;border-bottom:2px solid var(--sand)}
  .ptab{flex:1;padding:12px;text-align:center;font-size:.7rem;font-weight:600;letter-spacing:.12em;text-transform:uppercase;color:var(--taupe);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .2s}
  .ptab.active{color:var(--dark);border-bottom-color:var(--gold)}
  .ppanel{display:none}
  .ppanel.active{display:block}
  .pixbox{background:var(--white);border:1px solid var(--sand);padding:24px;text-align:center;margin-bottom:14px}
  .pkl{font-size:.63rem;letter-spacing:.2em;text-transform:uppercase;color:var(--taupe);margin-bottom:7px}
  .pk{font-family:var(--font-d);font-size:1.5rem;font-weight:500;letter-spacing:.05em;margin-bottom:14px}
  .pa{font-size:.78rem;color:var(--brown);margin-bottom:14px}
  .bcopy{background:var(--beige);border:none;padding:10px 22px;font-size:.68rem;font-weight:600;letter-spacing:.2em;text-transform:uppercase;color:var(--brown);cursor:pointer;transition:all .2s}
  .bcopy:hover{background:var(--sand)}
  .pnote{font-size:.71rem;color:var(--taupe);text-align:center;line-height:1.5;margin:12px 0}
  .fbtn{width:100%;background:var(--dark);color:var(--white);border:none;padding:18px;font-family:var(--font-b);font-size:.72rem;font-weight:600;letter-spacing:.25em;text-transform:uppercase;cursor:pointer;transition:all .2s;margin-top:8px;position:relative}
  .fbtn:hover{background:var(--brown)}
  .fbtn:disabled{opacity:.45;cursor:not-allowed}
  .fbtn.loading::after{content:'';position:absolute;right:18px;top:50%;transform:translateY(-50%);width:16px;height:16px;border:2px solid #ffffff44;border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite}
  @keyframes spin{to{transform:translateY(-50%) rotate(360deg)}}
  .suc-wrap{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;background:var(--dark);padding:40px 28px}
  .suc-icon{font-size:3rem;margin-bottom:18px}
  .suc-title{font-family:var(--font-d);font-size:2.4rem;font-weight:300;color:var(--white);margin-bottom:7px}
  .suc-sub{font-size:.73rem;color:var(--taupe);letter-spacing:.15em;text-transform:uppercase;margin-bottom:28px}
  .suc-info{background:#ffffff0f;border:1px solid #ffffff15;padding:20px;margin-bottom:28px;width:100%;max-width:320px;text-align:left}
  .sir{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #ffffff0f;font-size:.78rem}
  .sir:last-child{border-bottom:none}
  .sik{color:var(--taupe);font-size:.66rem;letter-spacing:.1em;text-transform:uppercase}
  .siv{color:var(--white);font-weight:500}
  /* PRO */
  #s-pro{background:var(--cream)}
  .psh{background:var(--white);border-bottom:1px solid var(--sand);padding:15px 22px}
  .psnb{font-family:var(--font-d);font-size:1.4rem;font-weight:300}
  .pssv{font-size:.63rem;color:var(--taupe);letter-spacing:.1em}
  .pro-tabs{display:flex;border-bottom:2px solid var(--sand);background:var(--white);overflow-x:auto}
  .pro-tab{flex:1;min-width:60px;padding:11px 3px;text-align:center;font-size:.56rem;font-weight:600;letter-spacing:.05em;text-transform:uppercase;color:var(--taupe);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .2s;white-space:nowrap}
  .pro-tab.active{color:var(--dark);border-bottom-color:var(--gold)}
  .pro-panel{display:none}
  .pro-panel.active{display:block}
  .dnav{display:flex;align-items:center;justify-content:space-between;padding:13px 22px;background:var(--white);border-bottom:1px solid var(--beige)}
  .dnbtn{width:34px;height:34px;border:1.5px solid var(--sand);background:none;color:var(--brown);font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
  .dnbtn:hover{border-color:var(--dark);color:var(--dark)}
  .dcurr{text-align:center}
  .dday{font-family:var(--font-d);font-size:1.6rem;font-weight:400;line-height:1}
  .dmon{font-size:.63rem;letter-spacing:.15em;text-transform:uppercase;color:var(--taupe)}
  .pslist{padding:14px 22px 40px}
  .sitem{background:var(--white);border:1px solid var(--sand);padding:13px 15px;margin-bottom:10px}
  .sitem-top{display:flex;gap:13px;align-items:flex-start}
  .stime{font-family:var(--font-d);font-size:1.1rem;font-weight:300;color:var(--gold);min-width:46px;padding-top:2px}
  .sim{font-size:.83rem;font-weight:500;margin-bottom:3px}
  .sis{font-size:.7rem;color:var(--taupe)}
  .sitem-actions{display:flex;gap:7px;margin-top:10px;padding-top:10px;border-top:1px solid var(--beige);flex-wrap:wrap}
  /* DISP */
  .disp-header{padding:16px 22px 10px;background:var(--white);border-bottom:1px solid var(--sand)}
  .disp-info{font-size:.7rem;color:var(--taupe);line-height:1.5;margin-top:8px}
  .disp-body{padding:16px 22px 40px}
  .disp-section{margin-bottom:22px}
  .disp-title{font-size:.63rem;font-weight:700;letter-spacing:.2em;text-transform:uppercase;color:var(--brown);margin-bottom:10px}
  .slot-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:7px}
  .slot-btn{padding:11px 4px;border:1.5px solid var(--sand);background:var(--white);font-size:.78rem;font-weight:500;color:var(--taupe);text-align:center;cursor:pointer;transition:all .2s}
  .slot-btn.aberto{border-color:var(--success);background:#edf7f0;color:var(--success);font-weight:700}
  .slot-btn.ocupado{opacity:.4;pointer-events:none;text-decoration:line-through;background:var(--beige)}
  .disp-actions{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
  .btn-disp{flex:1;min-width:100px;padding:11px;font-size:.62rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase;border:1.5px solid;cursor:pointer;transition:all .2s;background:transparent}
  .btn-abre{border-color:var(--success);color:var(--success)}
  .btn-abre:hover{background:var(--success);color:white}
  .btn-fecha{border-color:var(--taupe);color:var(--taupe)}
  .btn-fecha:hover{background:var(--taupe);color:white}
  .btn-semana{border-color:var(--gold);color:var(--brown)}
  .btn-semana:hover{background:var(--gold);color:var(--dark)}
  .btn-mes{border-color:var(--brown);color:var(--brown)}
  .btn-mes:hover{background:var(--brown);color:white}
  .disp-saved{display:none;text-align:center;padding:10px;font-size:.72rem;color:var(--success);letter-spacing:.1em;margin-top:8px}
  /* GERENCIAL */
  .ger-stats{display:grid;grid-template-columns:1fr 1fr;gap:11px;padding:18px 22px 0}
  .ger-card{background:var(--white);border:1px solid var(--sand);padding:16px 13px;text-align:center}
  .ger-num{font-family:var(--font-d);font-size:2rem;font-weight:300;line-height:1}
  .ger-lbl{font-size:.6rem;letter-spacing:.15em;text-transform:uppercase;color:var(--taupe);margin-top:3px}
  .ger-section{padding:16px 22px}
  .ger-title{font-size:.63rem;font-weight:700;letter-spacing:.2em;text-transform:uppercase;color:var(--brown);margin-bottom:12px}
  .ger-filter{display:flex;gap:7px;margin-bottom:14px;overflow-x:auto;padding-bottom:3px}
  .ger-chip{padding:6px 13px;border:1.5px solid var(--sand);background:var(--white);font-size:.63rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--taupe);white-space:nowrap;cursor:pointer;transition:all .2s}
  .ger-chip.active{border-color:var(--dark);background:var(--dark);color:var(--white)}
  .acard{background:var(--white);border:1px solid var(--sand);padding:15px;margin-bottom:10px}
  .atop{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:9px}
  .aname{font-family:var(--font-d);font-size:1.08rem;font-weight:500}
  .astatus{font-size:.56rem;font-weight:700;letter-spacing:.15em;text-transform:uppercase;padding:4px 9px}
  .st-p{background:#fff8e6;color:#a87800;border:1px solid #e6c96e}
  .st-c{background:#edf7f0;color:var(--success);border:1px solid #a8d4b4}
  .st-x{background:#fdecea;color:var(--error);border:1px solid #f0b4ae}
  .adet{font-size:.73rem;color:var(--taupe);margin-bottom:3px}
  .aact{display:flex;gap:7px;margin-top:11px;padding-top:11px;border-top:1px solid var(--beige);flex-wrap:wrap}
  .bact{flex:1;min-width:55px;padding:8px 5px;font-size:.6rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase;border:1.5px solid;cursor:pointer;transition:all .2s;background:transparent;text-align:center}
  .bconf{border-color:var(--success);color:var(--success)}
  .bconf:hover{background:var(--success);color:white}
  .bcanc{border-color:var(--error);color:var(--error)}
  .bcanc:hover{background:var(--error);color:white}
  .breag{border-color:var(--gold);color:var(--brown)}
  .breag:hover{background:var(--gold);color:var(--dark)}
  .bnota{border-color:var(--taupe);color:var(--taupe)}
  .bnota:hover{background:var(--taupe);color:white}
  .empty{text-align:center;padding:36px 16px;color:var(--taupe);font-size:.78rem}
  /* SENHA */
  .senha-box{background:var(--white);border:1px solid var(--sand);padding:22px;margin:16px 22px}
  .senha-title{font-family:var(--font-d);font-size:1.3rem;font-weight:300;margin-bottom:4px}
  .senha-sub{font-size:.65rem;color:var(--taupe);letter-spacing:.12em;text-transform:uppercase;margin-bottom:20px}
  .senha-ok{display:none;color:var(--success);font-size:.73rem;text-align:center;padding:8px;margin-top:8px}
  .senha-err{display:none;color:var(--error);font-size:.73rem;text-align:center;padding:8px;margin-top:8px;background:#fdecea;border:1px solid #f0b4ae}
  /* LOGIN */
  .lbox{background:var(--white);border:1px solid var(--sand);padding:30px 26px;margin:28px 22px}
  .ltitle{font-family:var(--font-d);font-size:1.8rem;font-weight:300;margin-bottom:3px}
  .lsub{font-size:.66rem;color:var(--taupe);letter-spacing:.12em;text-transform:uppercase;margin-bottom:26px}
  .lerr{background:#fdecea;border:1px solid #f0b4ae;color:var(--error);font-size:.73rem;padding:10px 13px;margin-bottom:14px;display:none}
  .lswitch{text-align:center;font-size:.72rem;color:var(--taupe);margin-top:16px}
  .lswitch a{color:var(--brown);cursor:pointer;text-decoration:underline}
  .psel{display:flex;flex-direction:column;gap:10px;margin-bottom:22px}
  .pselbtn{padding:13px 15px;background:var(--white);border:1.5px solid var(--sand);text-align:left;cursor:pointer;transition:all .2s;font-family:var(--font-b)}
  .pselbtn:hover,.pselbtn.active{border-color:var(--gold);background:#fdf8f0}
  .psn{font-size:.88rem;font-weight:500}
  .psr{font-size:.66rem;color:var(--taupe);margin-top:2px}
  /* CLIENTES */
  .cli-list{padding:14px 22px 40px}
  .cli-card{background:var(--white);border:1px solid var(--sand);padding:15px;margin-bottom:10px;cursor:pointer;transition:all .2s}
  .cli-card:hover{border-color:var(--gold)}
  .cli-name{font-family:var(--font-d);font-size:1.1rem;font-weight:500;margin-bottom:3px}
  .cli-info{font-size:.7rem;color:var(--taupe)}
  .cli-last{font-size:.68rem;color:var(--brown);margin-top:4px}
  .cli-nota-tag{display:inline-block;background:#fff8e6;border:1px solid #e6c96e;color:#a87800;font-size:.58rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:3px 8px;margin-top:5px}
  /* DETALHE CLIENTE */
  .cli-detail-header{background:var(--white);border-bottom:1px solid var(--sand);padding:18px 22px}
  .cli-detail-name{font-family:var(--font-d);font-size:1.6rem;font-weight:300;margin-bottom:3px}
  .cli-detail-info{font-size:.7rem;color:var(--taupe);line-height:1.8;white-space:pre-line}
  .nota-geral-box{margin:16px 22px;background:var(--white);border:1px solid var(--sand);padding:18px}
  .nota-geral-title{font-size:.63rem;font-weight:700;letter-spacing:.2em;text-transform:uppercase;color:var(--brown);margin-bottom:10px}
  .nota-geral-text{font-size:.82rem;color:var(--dark);line-height:1.6;margin-bottom:10px;min-height:24px}
  .hist-section{padding:0 22px 40px}
  .hist-title{font-size:.63rem;font-weight:700;letter-spacing:.2em;text-transform:uppercase;color:var(--brown);margin:16px 0 10px}
  .hist-item{background:var(--white);border:1px solid var(--sand);padding:14px;margin-bottom:10px}
  .hist-date{font-size:.65rem;letter-spacing:.1em;text-transform:uppercase;color:var(--taupe);margin-bottom:4px}
  .hist-svc{font-size:.85rem;font-weight:500;margin-bottom:4px}
  .hist-nota{font-size:.75rem;color:var(--brown);font-style:italic;margin-top:8px;padding-top:8px;border-top:1px solid var(--beige)}
  .hist-nota-label{font-size:.6rem;font-weight:700;letter-spacing:.15em;text-transform:uppercase;color:var(--taupe);margin-bottom:3px;font-style:normal;display:block}
  /* PERFIL CLIENTE */
  .cli-perfil-box{background:var(--white);border:1px solid var(--sand);padding:22px;margin:16px 22px}
  .cli-perfil-name{font-family:var(--font-d);font-size:1.4rem;font-weight:300;margin-bottom:3px}
  .cli-perfil-email{font-size:.7rem;color:var(--taupe);margin-bottom:16px}
  /* TOAST & OVERLAY */
  #toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--dark);color:var(--white);padding:12px 22px;font-size:.76rem;letter-spacing:.05em;z-index:9999;transition:transform .3s;white-space:nowrap;max-width:90vw;text-align:center}
  #toast.show{transform:translateX(-50%) translateY(0)}
  #overlay{display:none;position:fixed;inset:0;background:#00000055;z-index:8000;align-items:center;justify-content:center}
  #overlay.show{display:flex}
  .spinner{width:40px;height:40px;border:3px solid #ffffff33;border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite}
  .modal{display:none;position:fixed;inset:0;background:#00000077;z-index:7000;align-items:center;justify-content:center;padding:20px}
  .modal.show{display:flex}
  .modal-box{background:var(--white);padding:28px;width:100%;max-width:360px;border:1px solid var(--sand);max-height:90vh;overflow-y:auto}
  .modal-title{font-family:var(--font-d);font-size:1.5rem;font-weight:300;margin-bottom:16px}
  .modal-actions{display:flex;gap:10px;margin-top:16px}
</style>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600&family=Jost:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
<div id="overlay"><div class="spinner"></div></div>
<div id="toast"></div>

<!-- MODAL PERIODO -->
<div class="modal" id="modal-periodo">
  <div class="modal-box">
    <div class="modal-title">Disponibilizar por per√≠odo</div>
    <p style="font-size:.78rem;color:var(--taupe);margin-bottom:16px">Os hor√°rios abertos hoje ser√£o copiados para os pr√≥ximos dias.</p>
    <div class="fg"><label class="fl">At√© qual data?</label><input class="fi" type="date" id="modal-ate" /></div>
    <div class="modal-actions">
      <button class="fbtn" style="margin:0" onclick="aplicarPeriodo()">Aplicar</button>
      <button class="fbtn" style="margin:0;background:var(--taupe)" onclick="closeModal('modal-periodo')">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL REAGENDAR -->
<div class="modal" id="modal-reagendar">
  <div class="modal-box">
    <div class="modal-title">Reagendar</div>
    <p id="reag-info" style="font-size:.78rem;color:var(--taupe);margin-bottom:16px"></p>
    <div class="fg"><label class="fl">Nova data</label><input class="fi" type="date" id="reag-date" onchange="carregarHorariosReag()" /></div>
    <div class="fg"><label class="fl">Novo hor√°rio</label>
      <select class="fi" id="reag-time"><option value="">Selecione a data primeiro</option></select>
    </div>
    <div class="modal-actions">
      <button class="fbtn" style="margin:0" onclick="confirmarReagendamento()">Confirmar</button>
      <button class="fbtn" style="margin:0;background:var(--taupe)" onclick="closeModal('modal-reagendar')">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL NOTA AGENDAMENTO -->
<div class="modal" id="modal-nota-ag">
  <div class="modal-box">
    <div class="modal-title">Anota√ß√£o do Atendimento</div>
    <p style="font-size:.73rem;color:var(--taupe);margin-bottom:14px">Vis√≠vel apenas para voc√™.</p>
    <div class="fg"><textarea class="fi" id="nota-ag-text" rows="4" placeholder="Ex: cliente pediu sobrancelha mais fina..."></textarea></div>
    <div class="modal-actions">
      <button class="fbtn" style="margin:0" onclick="salvarNotaAgendamento()">Salvar</button>
      <button class="fbtn" style="margin:0;background:var(--taupe)" onclick="closeModal('modal-nota-ag')">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL NOTA CLIENTE -->
<div class="modal" id="modal-nota-cli">
  <div class="modal-box">
    <div class="modal-title">Anota√ß√£o da Cliente</div>
    <p style="font-size:.73rem;color:var(--taupe);margin-bottom:14px">Vis√≠vel para todas as profissionais.</p>
    <div class="fg"><textarea class="fi" id="nota-cli-text" rows="4" placeholder="Ex: pele sens√≠vel, alergia a X..."></textarea></div>
    <div class="modal-actions">
      <button class="fbtn" style="margin:0" onclick="salvarNotaCliente()">Salvar</button>
      <button class="fbtn" style="margin:0;background:var(--taupe)" onclick="closeModal('modal-nota-cli')">Cancelar</button>
    </div>
  </div>
</div>

<!-- HOME -->
<div id="s-home" class="screen active">
  <div class="h-logo">Studio Flow</div>
  <div class="h-tag">Beleza & Bem-estar</div>
  <div class="h-div"></div>
  <div class="h-btns">
    <button class="btn-p" onclick="irParaAgendamento()">Agendar Hor√°rio</button>
    <button class="btn-s" onclick="go('s-pro-login')">Acesso Profissional</button>
  </div>
  <div id="h-cli-info" style="display:none;margin-top:20px;padding:12px 20px;background:#ffffff12;border:1px solid #ffffff20;max-width:280px;text-align:center;position:relative">
    <div style="font-size:.62rem;letter-spacing:.18em;text-transform:uppercase;color:var(--taupe);margin-bottom:4px">Logado como</div>
    <div id="h-cli-nome" style="font-family:var(--font-d);font-size:1.1rem;color:var(--white);margin-bottom:8px">‚Äì</div>
    <button onclick="clienteLogout()" style="background:transparent;border:1px solid #ffffff22;color:var(--taupe);font-size:.62rem;font-weight:600;letter-spacing:.18em;text-transform:uppercase;padding:6px 16px;cursor:pointer;transition:all .2s" onmouseover="this.style.borderColor='#ffffff55';this.style.color='#fff'" onmouseout="this.style.borderColor='#ffffff22';this.style.color='var(--taupe)'">Trocar conta</button>
  </div>
  <div class="h-bottom">08h ‚Äì 20h ¬∑ Segunda a S√°bado</div>
</div>

<!-- LOGIN CLIENTE -->
<div id="s-cli-login" class="screen">
  <div class="ph"><div><div class="ph-logo">Studio Flow</div><div class="ph-sub">Minha Conta</div></div><button class="btn-back" onclick="go('s-home')">‚Üê</button></div>
  <div class="pb">
    <div class="lbox">
      <div class="ltitle">Entrar</div>
      <div class="lsub">Para agendar seu hor√°rio</div>
      <div class="lerr" id="cli-login-err"></div>
      <div class="fg"><label class="fl">E-mail</label><input class="fi" type="email" id="cli-login-email" placeholder="seu@email.com" /></div>
      <div class="fg"><label class="fl">Senha</label><input class="fi" type="password" id="cli-login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')clienteLogin()" /></div>
      <button class="fbtn" onclick="clienteLogin()">Entrar</button>
      <div class="lswitch">N√£o tem conta? <a onclick="go('s-cli-cadastro')">Criar cadastro</a></div>
    </div>
  </div>
</div>

<!-- CADASTRO CLIENTE -->
<div id="s-cli-cadastro" class="screen">
  <div class="ph"><div><div class="ph-logo">Studio Flow</div><div class="ph-sub">Criar Conta</div></div><button class="btn-back" onclick="go('s-cli-login')">‚Üê</button></div>
  <div class="pb">
    <div class="lbox">
      <div class="ltitle">Cadastrar</div>
      <div class="lsub">Crie sua conta para agendar</div>
      <div class="lerr" id="cli-cad-err"></div>
      <div class="fg"><label class="fl">Nome completo</label><input class="fi" type="text" id="cad-nome" placeholder="Maria Silva" /></div>
      <div class="fg"><label class="fl">WhatsApp</label><input class="fi" type="tel" id="cad-phone" placeholder="(11) 9 9999-9999" oninput="maskPhone(this)" /></div>
      <div class="fg"><label class="fl">E-mail</label><input class="fi" type="email" id="cad-email" placeholder="seu@email.com" /></div>
      <div class="fg"><label class="fl">Senha</label><input class="fi" type="password" id="cad-pass" placeholder="M√≠nimo 4 caracteres" /></div>
      <div class="fg"><label class="fl">Confirmar senha</label><input class="fi" type="password" id="cad-pass2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
      <button class="fbtn" onclick="clienteCadastrar()">Criar conta e agendar</button>
      <div class="lswitch">J√° tem conta? <a onclick="go('s-cli-login')">Entrar</a></div>
    </div>
  </div>
</div>

<!-- PERFIL CLIENTE -->
<div id="s-cli-perfil" class="screen">
  <div class="ph"><div><div class="ph-logo">Studio Flow</div><div class="ph-sub">Meu Perfil</div></div><button class="btn-back" onclick="go('s-home')">‚Üê</button></div>
  <div class="pb">
    <div class="cli-perfil-box">
      <div class="cli-perfil-name" id="perfil-name">‚Äì</div>
      <div class="cli-perfil-email" id="perfil-email">‚Äì</div>
      <div class="fg"><label class="fl">Telefone</label><input class="fi" type="tel" id="perfil-phone" oninput="maskPhone(this)" /></div>
      <div class="fg"><label class="fl">Data de nascimento</label><input class="fi" type="date" id="perfil-nasc" /></div>
      <div class="fg"><label class="fl">Observa√ß√µes (alergias, prefer√™ncias...)</label><textarea class="fi" id="perfil-obs" rows="3" placeholder="Ex: pele sens√≠vel, alergia a l√°tex..."></textarea></div>
      <button class="fbtn" onclick="salvarPerfil()">Salvar Perfil</button>
    </div>
    <div style="padding:0 22px">
      <button class="fbtn" style="background:transparent;color:var(--taupe);border:1px solid var(--sand)" onclick="clienteLogout()">Sair da conta</button>
    </div>
  </div>
</div>

<!-- BOOKING -->
<div id="s-booking" class="screen">
  <div class="ph"><div><div class="ph-logo">Studio Flow</div><div class="ph-sub">Agendamento</div></div><button class="btn-back" onclick="go('s-home')">‚Üê</button></div>
  <div class="pb">
    <div class="steps">
      <div class="step active"><div class="sn">1</div><div class="sl">Servi√ßo</div></div>
      <div class="sline"></div><div class="step"><div class="sn">2</div><div class="sl">Pagamento</div></div>
    </div>
    <div class="t1">Ol√°, <span id="bk-client-name">‚Äì</span>!</div>
    <div class="t2" style="margin-bottom:20px">Escolha profissional, servi√ßo e hor√°rio</div>
    <div class="t1" style="font-size:1.3rem">Profissional</div><div class="t2">Quem vai te atender?</div>
    <div class="pcards" id="pro-cards"></div>
    <div class="t1" style="font-size:1.3rem">Servi√ßo</div><div class="t2">O que voc√™ vai fazer?</div>
    <div class="chips" id="svc-chips"><div style="color:var(--taupe);font-size:.78rem;padding:4px 0">Selecione uma profissional primeiro</div></div>
    <div class="t1" style="font-size:1.3rem">Data</div><div class="t2">Escolha o dia</div>
    <div class="fg"><input class="fi" id="bk-date" type="date" onchange="loadSlots()" /></div>
    <div class="t1" style="font-size:1.3rem">Hor√°rio</div><div class="t2">Selecione um hor√°rio dispon√≠vel</div>
    <div class="tgrid" id="time-grid"><div style="grid-column:1/-1;text-align:center;color:var(--taupe);font-size:.78rem;padding:20px">Selecione profissional, servi√ßo e data</div></div>
    <button class="fbtn" onclick="step1Next()">Ir para Pagamento ‚Üí</button>
  </div>
</div>

<!-- PAYMENT -->
<div id="s-payment" class="screen">
  <div class="ph"><div><div class="ph-logo">Studio Flow</div><div class="ph-sub">Pagamento</div></div><button class="btn-back" onclick="go('s-booking')">‚Üê</button></div>
  <div class="pb">
    <div class="steps">
      <div class="step done"><div class="sn">‚úì</div><div class="sl">Servi√ßo</div></div>
      <div class="sline"></div><div class="step active"><div class="sn">2</div><div class="sl">Pagamento</div></div>
    </div>
    <div class="t1">Resumo</div><div class="t2">Confira antes de pagar</div>
    <div class="scard">
      <div class="srow"><span class="sk">Cliente</span><span class="sv" id="sm-name">‚Äì</span></div>
      <div class="srow"><span class="sk">Profissional</span><span class="sv" id="sm-pro">‚Äì</span></div>
      <div class="srow"><span class="sk">Servi√ßo</span><span class="sv" id="sm-svc">‚Äì</span></div>
      <div class="srow"><span class="sk">Dura√ß√£o</span><span class="sv" id="sm-dur">‚Äì</span></div>
      <div class="srow"><span class="sk">Data & Hor√°rio</span><span class="sv" id="sm-dt">‚Äì</span></div>
      <div class="srow" style="margin-top:7px;padding-top:12px;border-top:1px solid var(--sand)">
        <span class="sk">Taxa de agendamento</span><span class="stotal">R$ 30,00</span>
      </div>
    </div>
    <div class="ptabs">
      <div class="ptab active" onclick="payTab(this,'p-pix')">PIX</div>
      <div class="ptab" onclick="payTab(this,'p-card')">Cart√£o de Cr√©dito</div>
    </div>
    <div class="ppanel active" id="p-pix">
      <div class="pixbox">
        <div class="pkl">Chave PIX (CPF)</div>
        <div class="pk">095.253.535-16</div>
        <div class="pa">Valor a transferir: <strong>R$ 30,00</strong></div>
        <button class="bcopy" onclick="copyPix()">Copiar chave PIX</button>
      </div>
      <p class="pnote">Ap√≥s realizar o PIX, clique abaixo. Voc√™ receber√° a confirma√ß√£o por WhatsApp. üí¨</p>
      <button class="fbtn" id="btn-pix-confirm" onclick="confirmar('pix')">J√° realizei o PIX ‚Äì Confirmar</button>
    </div>
    <div class="ppanel" id="p-card">
      <div id="mp-card-form"></div>
      <p style="font-size:.7rem;color:var(--taupe);margin-top:12px">üîí Pagamento processado com seguran√ßa pelo Mercado Pago.</p>
      <button class="fbtn" id="btn-card-confirm" onclick="confirmar('cartao')">Pagar R$ 30,00 ‚Üí</button>
    </div>
  </div>
</div>

<!-- SUCCESS -->
<div id="s-success" class="screen">
  <div class="suc-wrap">
    <div class="suc-icon">‚ú®</div>
    <div class="suc-title">Agendado!</div>
    <div class="suc-sub">Confirma√ß√£o enviada por WhatsApp</div>
    <div class="suc-info">
      <div class="sir"><span class="sik">Cliente</span><span class="siv" id="sc-name">‚Äì</span></div>
      <div class="sir"><span class="sik">Profissional</span><span class="siv" id="sc-pro">‚Äì</span></div>
      <div class="sir"><span class="sik">Servi√ßo</span><span class="siv" id="sc-svc">‚Äì</span></div>
      <div class="sir"><span class="sik">Data & Hora</span><span class="siv" id="sc-dt">‚Äì</span></div>
      <div class="sir"><span class="sik">Pagamento</span><span class="siv" style="color:var(--gold)">Aguardando confirma√ß√£o</span></div>
    </div>
    <button class="btn-p" onclick="resetHome()">Voltar ao In√≠cio</button>
  </div>
</div>

<!-- PRO LOGIN -->
<div id="s-pro-login" class="screen">
  <div class="ph"><div><div class="ph-logo">Studio Flow</div><div class="ph-sub">Profissional</div></div><button class="btn-back" onclick="go('s-home')">‚Üê</button></div>
  <div class="pb">
    <div class="t1">Quem √© voc√™?</div><div class="t2">Selecione seu nome</div>
    <div class="psel" id="pro-sel-list"></div>
    <div class="fg"><label class="fl">Senha</label><input class="fi" type="password" id="pro-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')proLogin()" /></div>
    <div class="lerr" id="pro-err">Senha incorreta.</div>
    <button class="fbtn" onclick="proLogin()">Entrar</button>
  </div>
</div>

<!-- PRO AREA -->
<div id="s-pro" class="screen">
  <div class="ph">
    <div><div class="ph-logo">Studio Flow</div><div class="ph-sub" id="pro-sub-label">Minha √Årea</div></div>
    <button class="btn-back" onclick="go('s-home')">‚úï</button>
  </div>
  <div class="psh"><div class="psnb" id="pro-nm">‚Äì</div><div class="pssv" id="pro-sv">‚Äì</div></div>
  <div class="pro-tabs">
    <div class="pro-tab active" onclick="proTab(this,'pp-agenda')">üìÖ Agenda</div>
    <div class="pro-tab" onclick="proTab(this,'pp-disp')">‚è∞ Hor√°rios</div>
    <div class="pro-tab" onclick="proTab(this,'pp-clientes')">üë• Clientes</div>
    <div class="pro-tab" onclick="proTab(this,'pp-ger')">üìä Gerencial</div>
    <div class="pro-tab" onclick="proTab(this,'pp-config')">‚öôÔ∏è Config</div>
  </div>

  <!-- AGENDA -->
  <div class="pro-panel active" id="pp-agenda">
    <div class="dnav">
      <button class="dnbtn" onclick="proDateNav(-1)">‚Äπ</button>
      <div class="dcurr"><div class="dday" id="pro-dd">‚Äì</div><div class="dmon" id="pro-dm">‚Äì</div></div>
      <button class="dnbtn" onclick="proDateNav(1)">‚Ä∫</button>
    </div>
    <div class="pslist" id="pro-sched"></div>
  </div>

  <!-- HOR√ÅRIOS -->
  <div class="pro-panel" id="pp-disp">
    <div class="disp-header">
      <div class="dnav" style="padding:0;background:transparent;border:none">
        <button class="dnbtn" onclick="dispDateNav(-1)">‚Äπ</button>
        <div class="dcurr"><div class="dday" id="disp-dd">‚Äì</div><div class="dmon" id="disp-dm">‚Äì</div></div>
        <button class="dnbtn" onclick="dispDateNav(1)">‚Ä∫</button>
      </div>
      <div class="disp-info">Toque para abrir üü¢ ou fechar üîò. Hor√°rios com agendamento n√£o podem ser alterados.</div>
    </div>
    <div class="disp-body">
      <div class="disp-section"><div class="disp-title">Manh√£</div><div class="slot-grid" id="disp-manha"></div></div>
      <div class="disp-section"><div class="disp-title">Tarde</div><div class="slot-grid" id="disp-tarde"></div></div>
      <div class="disp-section"><div class="disp-title">Noite</div><div class="slot-grid" id="disp-noite"></div></div>
      <div class="disp-actions">
        <button class="btn-disp btn-abre" onclick="dispAbreTudo()">Abrir Tudo</button>
        <button class="btn-disp btn-fecha" onclick="dispFechaTudo()">Fechar Tudo</button>
        <button class="btn-disp btn-semana" onclick="abrirModalPeriodo('semana')">Copiar p/ Semana</button>
        <button class="btn-disp btn-mes" onclick="abrirModalPeriodo('mes')">Copiar p/ M√™s</button>
      </div>
      <button class="fbtn" onclick="salvarDisp()" style="margin-top:4px">Salvar Disponibilidade</button>
      <div class="disp-saved" id="disp-saved">‚úì Disponibilidade salva com sucesso!</div>
    </div>
  </div>

  <!-- CLIENTES -->
  <div class="pro-panel" id="pp-clientes">
    <div style="padding:14px 22px 8px;background:var(--white);border-bottom:1px solid var(--sand)">
      <input class="fi" type="text" id="cli-search" placeholder="Buscar cliente..." oninput="filtrarClientes(this.value)" style="margin:0" />
    </div>
    <div class="cli-list" id="cli-list-container"><div class="empty">Carregando...</div></div>
  </div>

  <!-- GERENCIAL -->
  <div class="pro-panel" id="pp-ger">
    <div class="ger-stats">
      <div class="ger-card"><div class="ger-num" id="ger-mes">‚Äì</div><div class="ger-lbl">Este m√™s</div></div>
      <div class="ger-card"><div class="ger-num" id="ger-rec">‚Äì</div><div class="ger-lbl">Arrecadado</div></div>
      <div class="ger-card"><div class="ger-num" id="ger-pend">‚Äì</div><div class="ger-lbl">Pendentes</div></div>
      <div class="ger-card"><div class="ger-num" id="ger-top">‚Äì</div><div class="ger-lbl">Top Servi√ßo</div></div>
    </div>
    <div class="ger-section">
      <div class="ger-title">Agendamentos</div>
      <div class="ger-filter">
        <div class="ger-chip active" onclick="gerFilter(this,'todos')">Todos</div>
        <div class="ger-chip" onclick="gerFilter(this,'pendente')">Pendentes</div>
        <div class="ger-chip" onclick="gerFilter(this,'confirmado')">Confirmados</div>
      </div>
      <div id="ger-lista"></div>
    </div>
  </div>

  <!-- CONFIG -->
  <div class="pro-panel" id="pp-config">
    <div class="senha-box">
      <div class="senha-title">Alterar Senha</div>
      <div class="senha-sub">Seguran√ßa da conta</div>
      <div class="fg"><label class="fl">Senha atual</label><input class="fi" type="password" id="senha-atual" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
      <div class="fg"><label class="fl">Nova senha</label><input class="fi" type="password" id="senha-nova" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
      <div class="fg"><label class="fl">Confirmar nova senha</label><input class="fi" type="password" id="senha-conf" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
      <div class="senha-err" id="senha-err"></div>
      <div class="senha-ok" id="senha-ok">‚úì Senha alterada com sucesso!</div>
      <button class="fbtn" onclick="alterarSenha()">Salvar Nova Senha</button>
    </div>
  </div>
</div>

<!-- DETALHE CLIENTE (tela pro) -->
<div id="s-cli-detail" class="screen">
  <div class="ph">
    <div><div class="ph-logo">Studio Flow</div><div class="ph-sub">Cliente</div></div>
    <button class="btn-back" id="btn-back-cli">‚Üê</button>
  </div>
  <div class="cli-detail-header">
    <div class="cli-detail-name" id="cd-name">‚Äì</div>
    <div class="cli-detail-info" id="cd-info">‚Äì</div>
  </div>
  <div class="nota-geral-box">
    <div class="nota-geral-title">üìå Anota√ß√£o Geral (vis√≠vel para todas as profissionais)</div>
    <div class="nota-geral-text" id="cd-nota-geral-text">Nenhuma anota√ß√£o ainda.</div>
    <button class="fbtn" style="margin-top:4px" onclick="abrirNotaCliente()">Editar Anota√ß√£o</button>
  </div>
  <div class="hist-section">
    <div class="hist-title">Hist√≥rico de Atendimentos</div>
    <div id="cd-historico"><div class="empty">Carregando...</div></div>
  </div>
</div>

<script>
const PROS=[
  {id:null,nome:'Samara Sodr√©',servicos:[
    {nome:'Alongamento de c√≠lios',dur:120},{nome:'Design de sobrancelhas',dur:40},
    {nome:'Design com Henna',dur:60},{nome:'Micro de sobrancelha',dur:150},
    {nome:'Micro de olhos',dur:150},{nome:'Micro labial',dur:150},
    {nome:'Remo√ß√£o de sinais/verrugas (Jato Plasma)',dur:60},
    {nome:'Lash lifting',dur:90},{nome:'Brow lamination',dur:60},
  ]},
  {id:null,nome:'Joice Almeida',servicos:[
    {nome:'Alongamento de c√≠lios',dur:120},{nome:'Design de sobrancelhas',dur:40},
    {nome:'Design com henna',dur:60},{nome:'Pl√°stica dos p√©s',dur:90},
    {nome:'Epila√ß√£o √≠ntima',dur:60},{nome:'Epila√ß√£o axila/bu√ßo',dur:30},
    {nome:'Epila√ß√£o pernas',dur:40},{nome:'Limpeza de pele',dur:120},
  ]},
  {id:null,nome:'Raquel Verusa',servicos:[
    {nome:'Alongamento de C√≠lios',dur:150},{nome:'Remo√ß√£o de C√≠lios',dur:30},
    {nome:'Design de Sobrancelhas',dur:60},{nome:'Design com Henna',dur:90},
  ]},
]
const TODOS_HORARIOS=['08:00','08:30','09:00','09:30','10:00','10:30','11:00','11:30','12:00','12:30','13:00','13:30','14:00','14:30','15:00','15:30','16:00','16:30','17:00','17:30','18:00','18:30','19:00','19:30']
function fmtDur(m){if(m<60)return m+'min';const h=Math.floor(m/60),r=m%60;return r?h+'h'+r+'min':h+'h'}
function fmtDate(s){if(!s)return'';const[y,m,d]=s.split('-');return d+'/'+m+'/'+y}
function escQ(s){return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'&quot;')}
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2600)}
function showOverlay(v){document.getElementById('overlay').classList.toggle('show',v)}
function go(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');window.scrollTo(0,0)}
function closeModal(id){document.getElementById(id).classList.remove('show')}
function maskPhone(input){let v=input.value.replace(/[^0-9]/g,'').substring(0,11);if(v.length>6)v='('+v.substring(0,2)+') '+v.substring(2,7)+'-'+v.substring(7);else if(v.length>2)v='('+v.substring(0,2)+') '+v.substring(2);input.value=v}

const S={
  pro:null,service:null,serviceDur:0,date:null,time:null,
  proUser:null,proDate:new Date(),dispDate:new Date(),dispSlots:{},
  gerFilter:'todos',gerAgendamentos:[],adminSecret:null,
  clienteLogado:null,
  cliAtual:null,
  reagAgId:null,reagProId:null,reagProNome:null,reagServico:null,reagDur:0,
  notaAgId:null,
  todosClientes:[],
}

// ===== INIT =====
async function initPros(){
  try{
    const res=await fetch('/api/profissionais')
    if(res.ok){const d=await res.json();d.profissionais.forEach((p,i)=>{if(PROS[i])PROS[i].id=p.id})}
  }catch(e){PROS.forEach((p,i)=>p.id='demo-'+i)}
  renderProCards();renderProSelList()
  const t=localStorage.getItem('cli_token'),c=localStorage.getItem('cli_data')
  if(t&&c){try{S.clienteLogado=JSON.parse(c)}catch(e){}}
  atualizarPainelHome()
}

// ===== AUTH CLIENTE =====
function atualizarPainelHome(){
  const info=document.getElementById('h-cli-info')
  if(S.clienteLogado){
    document.getElementById('h-cli-nome').textContent=S.clienteLogado.nome.split(' ')[0]
    info.style.display='block'
  } else {
    info.style.display='none'
  }
}
function irParaAgendamento(){
  if(!S.clienteLogado){go('s-cli-login');return}
  document.getElementById('bk-client-name').textContent=S.clienteLogado.nome.split(' ')[0]
  const today=new Date().toISOString().split('T')[0]
  const di=document.getElementById('bk-date')
  di.min=today;if(!di.value)di.value=today;S.date=di.value
  go('s-booking')
}
async function clienteLogin(){
  const email=document.getElementById('cli-login-email').value.trim()
  const pass=document.getElementById('cli-login-pass').value
  const err=document.getElementById('cli-login-err');err.style.display='none'
  if(!email||!pass){err.textContent='Preencha e-mail e senha';err.style.display='block';return}
  showOverlay(true)
  try{
    const res=await fetch('/api/clientes-auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,senha:pass})})
    const d=await res.json()
    if(!res.ok){err.textContent=d.error||'E-mail ou senha incorretos';err.style.display='block';return}
    S.clienteLogado=d.cliente
    localStorage.setItem('cli_token',d.token);localStorage.setItem('cli_data',JSON.stringify(d.cliente))
    document.getElementById('cli-login-email').value='';document.getElementById('cli-login-pass').value=''
    atualizarPainelHome()
    irParaAgendamento()
  }catch(e){err.textContent='Erro de conex√£o';err.style.display='block'}
  finally{showOverlay(false)}
}
async function clienteCadastrar(){
  const nome=document.getElementById('cad-nome').value.trim()
  const phone=document.getElementById('cad-phone').value.trim()
  const email=document.getElementById('cad-email').value.trim()
  const pass=document.getElementById('cad-pass').value
  const pass2=document.getElementById('cad-pass2').value
  const err=document.getElementById('cli-cad-err');err.style.display='none'
  if(!nome||!phone||!email||!pass){err.textContent='Preencha todos os campos';err.style.display='block';return}
  if(!email.includes('@')){err.textContent='E-mail inv√°lido';err.style.display='block';return}
  if(pass.length<4){err.textContent='Senha deve ter ao menos 4 caracteres';err.style.display='block';return}
  if(pass!==pass2){err.textContent='As senhas n√£o coincidem';err.style.display='block';return}
  showOverlay(true)
  try{
    const res=await fetch('/api/clientes-cadastro',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nome,telefone:phone,email,senha:pass})})
    const d=await res.json()
    if(!res.ok){err.textContent=d.error||'Erro ao criar conta';err.style.display='block';return}
    S.clienteLogado=d.cliente
    localStorage.setItem('cli_token',d.token);localStorage.setItem('cli_data',JSON.stringify(d.cliente))
    atualizarPainelHome()
    irParaAgendamento()
  }catch(e){err.textContent='Erro de conex√£o';err.style.display='block'}
  finally{showOverlay(false)}
}
function clienteLogout(){
  S.clienteLogado=null
  localStorage.removeItem('cli_token');localStorage.removeItem('cli_data')
  atualizarPainelHome()
  go('s-home')
}
async function salvarPerfil(){
  showOverlay(true)
  try{
    const res=await fetch('/api/clientes-perfil',{method:'PATCH',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+localStorage.getItem('cli_token')},
      body:JSON.stringify({telefone:document.getElementById('perfil-phone').value.trim(),data_nascimento:document.getElementById('perfil-nasc').value,observacoes:document.getElementById('perfil-obs').value.trim()})
    })
    if(res.ok){const d=await res.json();S.clienteLogado=d.cliente;localStorage.setItem('cli_data',JSON.stringify(d.cliente));toast('‚úì Perfil salvo!')}
    else toast('Erro ao salvar perfil')
  }catch(e){toast('Erro de conex√£o')}
  finally{showOverlay(false)}
}

// ===== BOOKING =====
function renderProCards(){
  const c=document.getElementById('pro-cards');c.innerHTML=''
  PROS.forEach(p=>{
    const el=document.createElement('div');el.className='pcard'
    el.innerHTML='<div class="pn">'+p.nome+'</div><div class="ps">'+p.servicos.map(s=>s.nome).join(' ¬∑ ')+'</div><div class="pck">‚úì</div>'
    el.onclick=()=>selectPro(el,p);c.appendChild(el)
  })
}
function selectPro(el,pro){
  document.querySelectorAll('#pro-cards .pcard').forEach(c=>c.classList.remove('sel'))
  el.classList.add('sel');S.pro=pro;S.service=null;S.serviceDur=0
  const chips=document.getElementById('svc-chips');chips.innerHTML=''
  pro.servicos.forEach(s=>{
    const c=document.createElement('div');c.className='chip'
    c.innerHTML=s.nome+' <span style="font-size:.65rem;opacity:.7">'+fmtDur(s.dur)+'</span>'
    c.onclick=()=>{document.querySelectorAll('#svc-chips .chip').forEach(x=>x.classList.remove('sel'));c.classList.add('sel');S.service=s.nome;S.serviceDur=s.dur;loadSlots()}
    chips.appendChild(c)
  })
  document.getElementById('time-grid').innerHTML='<div style="grid-column:1/-1;text-align:center;color:var(--taupe);font-size:.78rem;padding:20px">Selecione um servi√ßo para ver os hor√°rios</div>'
}
async function loadSlots(){
  const grid=document.getElementById('time-grid')
  S.date=document.getElementById('bk-date').value
  if(!S.pro||!S.date||!S.service){grid.innerHTML='<div style="grid-column:1/-1;text-align:center;color:var(--taupe);font-size:.78rem;padding:20px">Selecione um servi√ßo para ver os hor√°rios</div>';return}
  grid.innerHTML='<div style="grid-column:1/-1;text-align:center;color:var(--taupe);padding:20px;font-size:.78rem">Carregando...</div>'
  try{
    const res=await fetch('/api/horarios-disponiveis?profissional_id='+S.pro.id+'&data='+S.date+'&duracao='+S.serviceDur)
    const data=await res.json();renderSlots(data.horarios)
  }catch(e){renderSlots(TODOS_HORARIOS.map(h=>({horario:h,disponivel:true})))}
}
function renderSlots(horarios){
  const grid=document.getElementById('time-grid');grid.innerHTML='';S.time=null
  if(!horarios||!horarios.length){grid.innerHTML='<div style="grid-column:1/-1;text-align:center;color:var(--taupe);font-size:.78rem;padding:20px">Nenhum hor√°rio dispon√≠vel</div>';return}
  horarios.forEach(({horario,disponivel})=>{
    const el=document.createElement('div');el.className='ts'+(disponivel?'':' busy');el.textContent=horario
    if(disponivel)el.onclick=()=>{document.querySelectorAll('.ts').forEach(x=>x.classList.remove('sel'));el.classList.add('sel');S.time=horario}
    grid.appendChild(el)
  })
}
function step1Next(){
  if(!S.pro){toast('Selecione uma profissional');return}
  if(!S.service){toast('Selecione um servi√ßo');return}
  if(!S.date){toast('Escolha uma data');return}
  if(!S.time){toast('Selecione um hor√°rio');return}
  const cli=S.clienteLogado
  document.getElementById('sm-name').textContent=cli.nome
  document.getElementById('sm-pro').textContent=S.pro.nome
  document.getElementById('sm-svc').textContent=S.service
  document.getElementById('sm-dur').textContent=fmtDur(S.serviceDur)
  document.getElementById('sm-dt').textContent=fmtDate(S.date)+' √†s '+S.time
  go('s-payment')
}
function payTab(el,pid){document.querySelectorAll('.ptab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.ppanel').forEach(p=>p.classList.remove('active'));el.classList.add('active');document.getElementById(pid).classList.add('active')}
function copyPix(){navigator.clipboard.writeText('09525353516').then(()=>toast('Chave PIX copiada! ‚úì')).catch(()=>toast('09525353516'))}
async function confirmar(metodo){
  const btn=document.getElementById(metodo==='pix'?'btn-pix-confirm':'btn-card-confirm')
  btn.disabled=true;btn.classList.add('loading');showOverlay(true)
  const cli=S.clienteLogado
  try{
    const res=await fetch('/api/criar-pagamento',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+localStorage.getItem('cli_token')},body:JSON.stringify({cliente_id:cli.id,cliente_nome:cli.nome,cliente_telefone:cli.telefone,cliente_email:cli.email,profissional_id:S.pro.id,profissional_nome:S.pro.nome,servico:S.service,duracao:S.serviceDur,data:S.date,horario:S.time,metodo_pagamento:metodo})})
    const data=await res.json()
    if(!res.ok){toast('‚ö†Ô∏è '+(data.error||'Erro ao agendar'));return}
    if(metodo==='cartao'&&data.mp_init_point){window.location.href=data.mp_sandbox_init_point||data.mp_init_point;return}
    showSuccess()
  }catch(e){showSuccess()}
  finally{btn.disabled=false;btn.classList.remove('loading');showOverlay(false)}
}
function showSuccess(){
  const cli=S.clienteLogado
  document.getElementById('sc-name').textContent=cli.nome
  document.getElementById('sc-pro').textContent=S.pro.nome
  document.getElementById('sc-svc').textContent=S.service
  document.getElementById('sc-dt').textContent=fmtDate(S.date)+' √†s '+S.time
  go('s-success')
}
function resetHome(){
  S.pro=null;S.service=null;S.serviceDur=0;S.date=null;S.time=null
  document.querySelectorAll('#pro-cards .pcard').forEach(c=>c.classList.remove('sel'))
  document.getElementById('svc-chips').innerHTML='<div style="color:var(--taupe);font-size:.78rem;padding:4px 0">Selecione uma profissional primeiro</div>'
  document.getElementById('time-grid').innerHTML='<div style="grid-column:1/-1;text-align:center;color:var(--taupe);font-size:.78rem;padding:20px">Selecione profissional, servi√ßo e data</div>'
  go('s-home')
}

// ===== PRO LOGIN =====
let pendingPro=null
function renderProSelList(){
  const c=document.getElementById('pro-sel-list');c.innerHTML=''
  PROS.forEach(p=>{
    const el=document.createElement('button');el.className='pselbtn'
    el.innerHTML='<div class="psn">'+p.nome+'</div><div class="psr">'+p.servicos.map(s=>s.nome).join(' ¬∑ ')+'</div>'
    el.onclick=()=>{document.querySelectorAll('.pselbtn').forEach(x=>x.classList.remove('active'));el.classList.add('active');pendingPro=p}
    c.appendChild(el)
  })
}
async function proLogin(){
  const pass=document.getElementById('pro-pass').value
  if(!pendingPro){toast('Selecione seu nome primeiro');return}
  showOverlay(true)
  try{
    const res=await fetch('/api/pro-auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({profissional_id:pendingPro.id,senha:pass})})
    if(!res.ok)throw new Error()
    document.getElementById('pro-err').style.display='none'
    document.getElementById('pro-pass').value=''
    S.proUser=pendingPro;S.adminSecret=pass
    S.proDate=new Date();S.dispDate=new Date()
    document.getElementById('pro-nm').textContent=S.proUser.nome
    document.getElementById('pro-sv').textContent=S.proUser.servicos.map(s=>s.nome).join(' ¬∑ ')
    document.querySelectorAll('.pro-tab').forEach(t=>t.classList.remove('active'))
    document.querySelectorAll('.pro-panel').forEach(p=>p.classList.remove('active'))
    document.querySelector('.pro-tab').classList.add('active')
    document.getElementById('pp-agenda').classList.add('active')
    await renderProSched()
    go('s-pro')
  }catch(e){document.getElementById('pro-err').style.display='block'}
  finally{showOverlay(false)}
}
function proTab(el,pid){
  document.querySelectorAll('.pro-tab').forEach(t=>t.classList.remove('active'))
  document.querySelectorAll('.pro-panel').forEach(p=>p.classList.remove('active'))
  el.classList.add('active');document.getElementById(pid).classList.add('active')
  if(pid==='pp-disp')renderDispPanel()
  if(pid==='pp-ger')renderGerencial()
  if(pid==='pp-clientes')renderClientes()
}

// ===== AGENDA =====
async function renderProSched(){
  const d=S.proDate
  const days=['Dom','Seg','Ter','Qua','Qui','Sex','S√°b']
  const months=['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro']
  document.getElementById('pro-dd').textContent=days[d.getDay()]+' '+d.getDate()
  document.getElementById('pro-dm').textContent=months[d.getMonth()]+' '+d.getFullYear()
  const dateStr=d.toISOString().split('T')[0]
  const list=document.getElementById('pro-sched')
  list.innerHTML='<div style="text-align:center;color:var(--taupe);padding:24px;font-size:.78rem">Carregando...</div>'
  try{
    const res=await fetch('/api/agendamentos?profissional='+encodeURIComponent(S.proUser.nome)+'&data='+dateStr,{headers:{'x-admin-secret':S.adminSecret}})
    const data=await res.json();renderProList(data.agendamentos||[])
  }catch(e){renderProList([])}
}
function renderProList(bks){
  const list=document.getElementById('pro-sched');list.innerHTML=''
  const mine=bks.filter(b=>b.status!=='cancelado').sort((a,b)=>a.horario.localeCompare(b.horario))
  if(!mine.length){list.innerHTML='<div style="text-align:center;color:var(--taupe);padding:40px;font-size:.8rem">‚ú® Sem agendamentos neste dia</div>';return}
  mine.forEach(b=>{
    const el=document.createElement('div');el.className='sitem'
    const sc=b.status==='confirmado'?'var(--success)':'var(--gold)'
    const proId=escQ(b.profissional_id||S.proUser.id)
    const proNome=escQ(b.profissional_nome||S.proUser.nome)
    const svc=escQ(b.servico)
    const nota=escQ(b.nota_atendimento||'')
    el.innerHTML=
      '<div class="sitem-top">'+
        '<div class="stime">'+b.horario.substring(0,5)+'</div>'+
        '<div>'+
          '<div class="sim">'+b.cliente_nome+'</div>'+
          '<div class="sis">'+b.servico+' ¬∑ <span style="color:'+sc+'">'+(b.status==='confirmado'?'Confirmado':'Pendente')+'</span></div>'+
          '<div class="sis" style="margin-top:2px">üì± '+b.cliente_telefone+'</div>'+
          (b.nota_atendimento?'<div class="sis" style="margin-top:4px;color:var(--brown);font-style:italic">üìù '+b.nota_atendimento+'</div>':'')+
        '</div>'+
      '</div>'+
      '<div class="sitem-actions">'+
        '<button class="bact breag" onclick="abrirReagendar(\''+b.id+'\',\''+proId+'\',\''+proNome+'\',\''+svc+'\','+(b.duracao||60)+')">Reagendar</button>'+
        '<button class="bact bnota" onclick="abrirNotaAgendamento(\''+b.id+'\',\''+nota+'\')">Anotar</button>'+
      '</div>'
    list.appendChild(el)
  })
}
async function proDateNav(dir){S.proDate=new Date(S.proDate);S.proDate.setDate(S.proDate.getDate()+dir);await renderProSched()}

// ===== REAGENDAR =====
function abrirReagendar(id,proId,proNome,servico,dur){
  S.reagAgId=id;S.reagProId=proId;S.reagProNome=proNome;S.reagServico=servico;S.reagDur=dur
  document.getElementById('reag-info').textContent='Reagendando: '+servico+' com '+proNome
  const today=new Date().toISOString().split('T')[0]
  document.getElementById('reag-date').min=today;document.getElementById('reag-date').value=''
  document.getElementById('reag-time').innerHTML='<option value="">Selecione a data primeiro</option>'
  document.getElementById('modal-reagendar').classList.add('show')
}
async function carregarHorariosReag(){
  const date=document.getElementById('reag-date').value
  const sel=document.getElementById('reag-time')
  if(!date){sel.innerHTML='<option value="">Selecione a data primeiro</option>';return}
  sel.innerHTML='<option value="">Carregando...</option>'
  try{
    const res=await fetch('/api/horarios-disponiveis?profissional_id='+S.reagProId+'&data='+date+'&duracao='+S.reagDur)
    const data=await res.json()
    const horarios=(data.horarios||[]).filter(h=>h.disponivel)
    if(!horarios.length){sel.innerHTML='<option value="">Nenhum hor√°rio dispon√≠vel</option>';return}
    sel.innerHTML='<option value="">Selecione o hor√°rio</option>'
    horarios.forEach(h=>{const o=document.createElement('option');o.value=h.horario;o.textContent=h.horario;sel.appendChild(o)})
  }catch(e){sel.innerHTML='<option value="">Erro ao carregar</option>'}
}
async function confirmarReagendamento(){
  const date=document.getElementById('reag-date').value
  const time=document.getElementById('reag-time').value
  if(!date||!time){toast('Selecione data e hor√°rio');return}
  showOverlay(true)
  try{
    const res=await fetch('/api/agendamentos',{method:'PATCH',headers:{'Content-Type':'application/json','x-admin-secret':S.adminSecret},body:JSON.stringify({id:S.reagAgId,data:date,horario:time})})
    if(res.ok){closeModal('modal-reagendar');toast('‚úì Reagendado para '+fmtDate(date)+' √†s '+time);await renderProSched()}
    else toast('Erro ao reagendar')
  }catch(e){toast('Erro ao reagendar')}
  finally{showOverlay(false)}
}

// ===== ANOTA√á√ïES =====
function abrirNotaAgendamento(agId,notaAtual){
  S.notaAgId=agId
  document.getElementById('nota-ag-text').value=notaAtual
  document.getElementById('modal-nota-ag').classList.add('show')
}
async function salvarNotaAgendamento(){
  showOverlay(true)
  try{
    const res=await fetch('/api/agendamentos',{method:'PATCH',headers:{'Content-Type':'application/json','x-admin-secret':S.adminSecret},body:JSON.stringify({id:S.notaAgId,nota_atendimento:document.getElementById('nota-ag-text').value.trim()})})
    if(res.ok){closeModal('modal-nota-ag');toast('‚úì Anota√ß√£o salva!');await renderProSched()}
    else toast('Erro ao salvar anota√ß√£o')
  }catch(e){toast('Erro ao salvar')}
  finally{showOverlay(false)}
}
function abrirNotaCliente(){
  const atual=document.getElementById('cd-nota-geral-text').textContent
  document.getElementById('nota-cli-text').value=atual==='Nenhuma anota√ß√£o ainda.'?'':atual
  document.getElementById('modal-nota-cli').classList.add('show')
}
async function salvarNotaCliente(){
  if(!S.cliAtual)return
  const nota=document.getElementById('nota-cli-text').value.trim()
  showOverlay(true)
  try{
    const res=await fetch('/api/clientes/'+S.cliAtual.id+'/nota',{method:'PATCH',headers:{'Content-Type':'application/json','x-admin-secret':S.adminSecret},body:JSON.stringify({nota_geral:nota})})
    if(res.ok){closeModal('modal-nota-cli');document.getElementById('cd-nota-geral-text').textContent=nota||'Nenhuma anota√ß√£o ainda.';toast('‚úì Anota√ß√£o salva!')}
    else toast('Erro ao salvar')
  }catch(e){toast('Erro ao salvar')}
  finally{showOverlay(false)}
}

// ===== CLIENTES =====
async function renderClientes(){
  const c=document.getElementById('cli-list-container')
  c.innerHTML='<div class="empty">Carregando...</div>'
  try{
    const res=await fetch('/api/clientes?profissional='+encodeURIComponent(S.proUser.nome),{headers:{'x-admin-secret':S.adminSecret}})
    const d=await res.json()
    S.todosClientes=d.clientes||[]
    exibirListaClientes(S.todosClientes)
  }catch(e){c.innerHTML='<div class="empty">Erro ao carregar clientes</div>'}
}
function exibirListaClientes(lista){
  const c=document.getElementById('cli-list-container')
  if(!lista.length){c.innerHTML='<div class="empty">Nenhuma cliente encontrada</div>';return}
  c.innerHTML=''
  lista.forEach(cli=>{
    const el=document.createElement('div');el.className='cli-card'
    el.innerHTML=
      '<div class="cli-name">'+cli.nome+'</div>'+
      '<div class="cli-info">üì± '+(cli.telefone||'‚Äì')+' ¬∑ ‚úâÔ∏è '+(cli.email||'‚Äì')+'</div>'+
      (cli.ultimo_servico?'<div class="cli-last">√öltimo: '+cli.ultimo_servico+' em '+fmtDate(cli.ultima_data)+'</div>':'')+
      (cli.nota_geral?'<div class="cli-nota-tag">üìå Tem anota√ß√£o</div>':'')
    el.onclick=()=>abrirDetalheCliente(cli)
    c.appendChild(el)
  })
}
function filtrarClientes(q){
  const q2=q.toLowerCase()
  exibirListaClientes(S.todosClientes.filter(c=>c.nome.toLowerCase().includes(q2)||(c.telefone&&c.telefone.includes(q2))||(c.email&&c.email.toLowerCase().includes(q2))))
}
async function abrirDetalheCliente(cli){
  S.cliAtual=cli
  document.getElementById('cd-name').textContent=cli.nome
  document.getElementById('cd-info').textContent=
    'üì± '+(cli.telefone||'‚Äì')+'\n'+
    '‚úâÔ∏è '+(cli.email||'‚Äì')+
    (cli.data_nascimento?'\nüéÇ '+fmtDate(cli.data_nascimento):'')+
    (cli.observacoes?'\nüí¨ '+cli.observacoes:'')
  document.getElementById('cd-nota-geral-text').textContent=cli.nota_geral||'Nenhuma anota√ß√£o ainda.'
  document.getElementById('cd-historico').innerHTML='<div class="empty">Carregando...</div>'
  // bot√£o voltar volta para aba clientes
  document.getElementById('btn-back-cli').onclick=()=>{go('s-pro');proTab(document.querySelectorAll('.pro-tab')[2],'pp-clientes')}
  go('s-cli-detail')
  try{
    const res=await fetch('/api/agendamentos?cliente_id='+cli.id+'&profissional='+encodeURIComponent(S.proUser.nome),{headers:{'x-admin-secret':S.adminSecret}})
    const d=await res.json()
    renderHistorico(d.agendamentos||[])
  }catch(e){document.getElementById('cd-historico').innerHTML='<div class="empty">Erro ao carregar hist√≥rico</div>'}
}
function renderHistorico(ags){
  const c=document.getElementById('cd-historico')
  const list=[...ags].filter(b=>b.status!=='cancelado').sort((a,b)=>b.data.localeCompare(a.data)||b.horario.localeCompare(a.horario))
  if(!list.length){c.innerHTML='<div class="empty">Nenhum atendimento registrado</div>';return}
  c.innerHTML=''
  list.forEach(b=>{
    const el=document.createElement('div');el.className='hist-item'
    const stC=b.status==='confirmado'?'var(--success)':'var(--gold)'
    const proId=escQ(b.profissional_id||S.proUser.id)
    const proNome=escQ(b.profissional_nome||S.proUser.nome)
    const svc=escQ(b.servico)
    const nota=escQ(b.nota_atendimento||'')
    el.innerHTML=
      '<div class="hist-date">'+fmtDate(b.data)+' √†s '+b.horario.substring(0,5)+'</div>'+
      '<div class="hist-svc">'+b.servico+' <span style="font-size:.65rem;color:'+stC+'">'+(b.status==='confirmado'?'Confirmado':'Pendente')+'</span></div>'+
      (b.nota_atendimento?'<div class="hist-nota"><span class="hist-nota-label">Anota√ß√£o do atendimento</span>'+b.nota_atendimento+'</div>':'')+
      '<div style="display:flex;gap:7px;margin-top:10px">'+
        '<button class="bact breag" style="font-size:.58rem" onclick="abrirReagendar(\''+b.id+'\',\''+proId+'\',\''+proNome+'\',\''+svc+'\','+(b.duracao||60)+')">Reagendar</button>'+
        '<button class="bact bnota" style="font-size:.58rem" onclick="abrirNotaAgendamento(\''+b.id+'\',\''+nota+'\')">Anotar</button>'+
      '</div>'
    c.appendChild(el)
  })
}

// ===== DISPONIBILIDADE =====
async function renderDispPanel(){
  const d=S.dispDate
  const days=['Dom','Seg','Ter','Qua','Qui','Sex','S√°b']
  const months=['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro']
  document.getElementById('disp-dd').textContent=days[d.getDay()]+' '+d.getDate()
  document.getElementById('disp-dm').textContent=months[d.getMonth()]+' '+d.getFullYear()
  document.getElementById('disp-saved').style.display='none'
  const dateStr=d.toISOString().split('T')[0]
  let dispAtual={},ocupados=new Set()
  try{
    const[r1,r2]=await Promise.all([
      fetch('/api/disponibilidade?profissional_id='+S.proUser.id+'&data='+dateStr,{headers:{'x-admin-secret':S.adminSecret}}),
      fetch('/api/agendamentos?profissional='+encodeURIComponent(S.proUser.nome)+'&data='+dateStr,{headers:{'x-admin-secret':S.adminSecret}})
    ])
    if(r1.ok){const dd=await r1.json();dd.horarios.forEach(h=>{dispAtual[h.horario.substring(0,5)]=h.aberto===true||h.aberto==='true'})}
    if(r2.ok){const da=await r2.json();(da.agendamentos||[]).filter(b=>b.status!=='cancelado').forEach(b=>ocupados.add(b.horario.substring(0,5)))}
  }catch(e){}
  S.dispSlots={}
  TODOS_HORARIOS.forEach(h=>{S.dispSlots[h]=dispAtual.hasOwnProperty(h)?dispAtual[h]:false})
  renderDispSlots(ocupados)
}
function renderDispSlots(ocupados=new Set()){
  const manha=['08:00','08:30','09:00','09:30','10:00','10:30','11:00','11:30']
  const tarde=['12:00','12:30','13:00','13:30','14:00','14:30','15:00','15:30','16:00','16:30']
  const noite=['17:00','17:30','18:00','18:30','19:00','19:30']
  function rg(id,slots){
    const c=document.getElementById(id);c.innerHTML=''
    slots.forEach(h=>{
      const btn=document.createElement('div')
      const isOc=ocupados.has(h)
      btn.className='slot-btn'+(isOc?' ocupado':S.dispSlots[h]?' aberto':'')
      btn.textContent=h
      btn.onclick=()=>{if(isOc)return;S.dispSlots[h]=!S.dispSlots[h];btn.classList.toggle('aberto',S.dispSlots[h])}
      c.appendChild(btn)
    })
  }
  rg('disp-manha',manha);rg('disp-tarde',tarde);rg('disp-noite',noite)
}
function dispAbreTudo(){TODOS_HORARIOS.forEach(h=>S.dispSlots[h]=true);document.querySelectorAll('.slot-btn:not(.ocupado)').forEach(b=>b.classList.add('aberto'))}
function dispFechaTudo(){TODOS_HORARIOS.forEach(h=>S.dispSlots[h]=false);document.querySelectorAll('.slot-btn:not(.ocupado)').forEach(b=>b.classList.remove('aberto'))}
async function salvarDisp(){
  const dateStr=S.dispDate.toISOString().split('T')[0]
  const horarios=Object.entries(S.dispSlots).map(([horario,aberto])=>({horario,aberto}))
  showOverlay(true)
  try{
    const res=await fetch('/api/disponibilidade',{method:'POST',headers:{'Content-Type':'application/json','x-admin-secret':S.adminSecret},body:JSON.stringify({profissional_id:S.proUser.id,data:dateStr,horarios})})
    if(res.ok){document.getElementById('disp-saved').style.display='block';toast('‚úì Disponibilidade salva!')}
    else toast('Erro ao salvar')
  }catch(e){toast('Erro ao salvar')}
  finally{showOverlay(false)}
}
async function dispDateNav(dir){S.dispDate=new Date(S.dispDate);S.dispDate.setDate(S.dispDate.getDate()+dir);await renderDispPanel()}

// ===== PER√çODO =====
function abrirModalPeriodo(tipo){
  const hoje=new Date(S.dispDate),ate=new Date(hoje)
  if(tipo==='semana')ate.setDate(ate.getDate()+6);else ate.setMonth(ate.getMonth()+1)
  document.getElementById('modal-ate').value=ate.toISOString().split('T')[0]
  document.getElementById('modal-ate').min=new Date(hoje.getTime()+86400000).toISOString().split('T')[0]
  document.getElementById('modal-periodo').classList.add('show')
}
async function aplicarPeriodo(){
  const ate=document.getElementById('modal-ate').value
  if(!ate){toast('Selecione uma data');return}
  closeModal('modal-periodo');showOverlay(true)
  const horarios=Object.entries(S.dispSlots).map(([horario,aberto])=>({horario,aberto}))
  const inicio=new Date(S.dispDate);inicio.setDate(inicio.getDate()+1)
  const fim=new Date(ate)
  let erros=0,salvos=0,promises=[]
  for(let d=new Date(inicio);d<=fim;d.setDate(d.getDate()+1)){
    const dateStr=new Date(d).toISOString().split('T')[0]
    promises.push(fetch('/api/disponibilidade',{method:'POST',headers:{'Content-Type':'application/json','x-admin-secret':S.adminSecret},body:JSON.stringify({profissional_id:S.proUser.id,data:dateStr,horarios})}).then(r=>r.ok?salvos++:erros++).catch(()=>erros++))
  }
  await Promise.all(promises)
  showOverlay(false)
  toast(erros===0?'‚úì Copiado para '+salvos+' dias!':'Copiado com '+erros+' erros')
}

// ===== GERENCIAL =====
async function renderGerencial(){
  showOverlay(true)
  try{
    const res=await fetch('/api/agendamentos?profissional='+encodeURIComponent(S.proUser.nome),{headers:{'x-admin-secret':S.adminSecret}})
    const data=await res.json()
    S.gerAgendamentos=data.agendamentos||[]
    atualizarGerencial()
  }catch(e){document.getElementById('ger-lista').innerHTML='<div class="empty">Erro ao carregar</div>'}
  finally{showOverlay(false)}
}
function atualizarGerencial(){
  const all=S.gerAgendamentos,mes=new Date().toISOString().substring(0,7)
  const doMes=all.filter(b=>b.data&&b.data.substring(0,7)===mes)
  const conf=doMes.filter(b=>b.status==='confirmado')
  const pend=all.filter(b=>b.status==='pendente')
  const svcCount={}
  all.forEach(b=>{if(b.servico)svcCount[b.servico]=(svcCount[b.servico]||0)+1})
  const topSvc=Object.entries(svcCount).sort((a,b)=>b[1]-a[1])[0]
  document.getElementById('ger-mes').textContent=doMes.length
  document.getElementById('ger-rec').textContent='R$'+(conf.length*30)
  document.getElementById('ger-pend').textContent=pend.length
  document.getElementById('ger-top').textContent=topSvc?topSvc[0].split(' ')[0]:'‚Äì'
  renderGerLista()
}
function gerFilter(el,val){
  document.querySelectorAll('.ger-chip').forEach(c=>c.classList.remove('active'))
  el.classList.add('active');S.gerFilter=val;renderGerLista()
}
function renderGerLista(){
  const c=document.getElementById('ger-lista');c.innerHTML=''
  let f=S.gerAgendamentos
  if(S.gerFilter==='pendente')f=f.filter(b=>b.status==='pendente')
  if(S.gerFilter==='confirmado')f=f.filter(b=>b.status==='confirmado')
  f=[...f].sort((a,b)=>b.data.localeCompare(a.data)||b.horario.localeCompare(a.horario))
  if(!f.length){c.innerHTML='<div class="empty">üìÖ Nenhum agendamento.</div>';return}
  f.forEach(b=>{
    const el=document.createElement('div');el.className='acard'
    const stL=b.status==='confirmado'?'Confirmado':b.status==='pendente'?'Pendente':'Cancelado'
    const stC=b.status==='confirmado'?'st-c':b.status==='pendente'?'st-p':'st-x'
    const proId=escQ(b.profissional_id||S.proUser.id)
    const proNome=escQ(b.profissional_nome||S.proUser.nome)
    const svc=escQ(b.servico)
    const nota=escQ(b.nota_atendimento||'')
    el.innerHTML=
      '<div class="atop"><div class="aname">'+b.cliente_nome+'</div><div class="astatus '+stC+'">'+stL+'</div></div>'+
      '<div class="adet">üóì '+fmtDate(b.data)+' √†s '+b.horario.substring(0,5)+'</div>'+
      '<div class="adet">üíÖ '+b.servico+'</div>'+
      '<div class="adet">üì± '+b.cliente_telefone+'</div>'+
      (b.nota_atendimento?'<div class="adet" style="color:var(--brown);font-style:italic">üìù '+b.nota_atendimento+'</div>':'')+
      '<div class="aact">'+
        (b.status==='pendente'?'<button class="bact bconf" onclick="gerUpdStatus(\''+b.id+'\',\'confirmado\')">Confirmar</button>':'')+
        (b.status!=='cancelado'?'<button class="bact bcanc" onclick="gerUpdStatus(\''+b.id+'\',\'cancelado\')">Cancelar</button>':'')+
        '<button class="bact breag" onclick="abrirReagendar(\''+b.id+'\',\''+proId+'\',\''+proNome+'\',\''+svc+'\','+(b.duracao||60)+')">Reagendar</button>'+
        '<button class="bact bnota" onclick="abrirNotaAgendamento(\''+b.id+'\',\''+nota+'\')">Anotar</button>'+
      '</div>'
    c.appendChild(el)
  })
}
async function gerUpdStatus(id,status){
  showOverlay(true)
  try{
    const res=await fetch('/api/agendamentos',{method:'PATCH',headers:{'Content-Type':'application/json','x-admin-secret':S.adminSecret},body:JSON.stringify({id,status})})
    if(res.ok){const b=S.gerAgendamentos.find(x=>x.id===id);if(b)b.status=status;atualizarGerencial();toast(status==='confirmado'?'‚úì Confirmado!':'‚úó Cancelado')}
  }finally{showOverlay(false)}
}

// ===== SENHA =====
async function alterarSenha(){
  const atual=document.getElementById('senha-atual').value
  const nova=document.getElementById('senha-nova').value
  const conf=document.getElementById('senha-conf').value
  const err=document.getElementById('senha-err'),ok=document.getElementById('senha-ok')
  err.style.display='none';ok.style.display='none'
  if(!atual||!nova||!conf){err.textContent='Preencha todos os campos';err.style.display='block';return}
  if(nova!==conf){err.textContent='As senhas n√£o coincidem';err.style.display='block';return}
  if(nova.length<4){err.textContent='Senha deve ter ao menos 4 caracteres';err.style.display='block';return}
  showOverlay(true)
  try{
    const res=await fetch('/api/pro-auth',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({profissional_id:S.proUser.id,senha_atual:atual,senha_nova:nova})})
    if(res.ok){S.adminSecret=nova;document.getElementById('senha-atual').value='';document.getElementById('senha-nova').value='';document.getElementById('senha-conf').value='';ok.style.display='block';toast('‚úì Senha alterada!')}
    else{const d=await res.json();err.textContent=d.error||'Senha atual incorreta';err.style.display='block'}
  }catch(e){err.textContent='Erro ao alterar senha';err.style.display='block'}
  finally{showOverlay(false)}
}

initPros()
</script>
</body>
</html>
